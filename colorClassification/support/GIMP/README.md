# Color Classification on GIMP2

Asuraのプログラム用の色分類(以降、色きり)の環境構築・実行手順。

__内容自体は2008年ごろのもの__


## TODO

* `thresh`や`tile`の行方が不明
* `magergb.ppm`の作りかた忘却
* Linuxでも可?
* これであってる?

## 準備

### 必要なもの

* Cygwin
* GIMP (2.x以降)
  * [ここらへん](http://www.gimp.org/)からとってきてインストール
* asura-create-layers.scm
  * GIMPの色きり用レイヤー作成スクリプト
  * このリポジトリ内`gimp-stuff`に入ってる
* AsuraColor.gpl
  * AsuraカラーのGIMP用パレット
  * このリポジトリ内`gimp-stuff`に入ってる
* irfanview?
  * Windows限定か?

### スクリプト類の配置

GIMPのユーザディレクトリ`C:\documents and settings\[ユーザ名]\.gimp-x.x\`(x.xはGIMPのバージョン)を開く。
_Linuxでは`/home/[username]/.gimp-x.x`を開く。_

もしディレクトリがない場合、初回起動がまだだと思われるので、いったんGIMPを起動し、閉じてみる。

ディレクトリ開いたら

* `palettes\` 内に `AsuraColor.gpl` を
* `scripts\` 内に `asura-create-layers.scm` を

置く。


## 色きり手順

色きり作業の手順。

### 概要

色きり作業は、大まかには次の流れで行う。
7.は色きり責任者の指示に従う。
8.は色きり責任者が行う。

1. 色きりディレクトリの用意
2. 色きりしたい、ロボットで撮った画像(.ppm)を所定のディレクトリに置く
3. `maketile`でタイル画像をつくる
4. スクリプトを実行して色きり用レイヤーを作る
5. 色きりを行う
6. ppm形式で保存する
7. `thresh`コマンドで色テーブルファイルを作る

### 1. 色きりディレクトリの用意

このリポジトリの`cc-template`ディレクトリを好きなところに置く。
このディレクトリを色きりの基本ディレクトリとする。
過去、フォルダは場所や状況ごとに使いわけたりしてた。
(2009年JapanOpen用など)

Cygwinのシェルで用意した色きりディレクトリ(以降`cc`)に移動しておく。

### 2. 色きり元画像の配置

ロボットで元画像を撮る。
撮るときはいろんな角度、いろんな距離で撮るよう心掛ける。

ロボットで撮った画像を種類別に振り分ける。

* Ball
  * 近すぎてハミ出てるボールも撮る
* Marker
  * いろんなビーコン
* Misc
  * コート周辺の紛らわしいものとか
  * ignore色にする
* Goal
  * ゴール周辺
* Aibo
  * AIBOやNAOの本体
  * 本体の白をignoreしてる画像を見かけたけど、実際どうなの?
* Field
  * ラインの白
* NearYellowGoal
  * 使ってないぽい。`ignorelist.txt`とか参照

### 3. 色きり用画像の作成

cygwinのシェルで

    $ _asura/make maketile

と打つ。
すると、BallやMarker等のフォルダ内の画像がひとつに纏められて`imageyuv.ppm`ができる。

このファイルを_RGBに変換するか、しないかして_色きりする。  
__TODO: ここ要追記__

### 4. GIMPで準備

まず、色きりに必要なレイヤーをつくる。
色きりしたいファイルを開いた状態でメニューの`フィルター`→`Asura CreateLayers`を選ぶ。
すると、BallとかCyanとかレイヤーが出来る。

つぎに、色きり用のパレットを開く。
メニューの`ウィンドウ`→`ドッキング可能なダイアログ`→`パレット`を選ぶ。

### 5. 色きり

ツールボックスの_ファジー選択_ツールで色きりを行う。

まず、ファジー選択ツールの__「アンチエイリアス(or なめらかに?)」「境界をぼかす」をオフ__にしておく。
つぎにBall、Cyan等の各色について、以下の手順を行う
(以下の説明ではBallの色きりを例に説明する):

1. 色きり画像中のBallに認識させたい色の部分をファジー選択ツールで選択する
2. Ballレイヤーを選び、1.で選択した範囲をパレットのBallの色で塗り潰す
3. Ball色にしたい部分がなくなるまで1.と2.を繰り返す

このとき、ファジー選択ツールの「しきい値」を調整すると、余分なところを選択されなかったり、「そこも選択してほしい」というようなところも選択できたりする。

なお、色きりは経験則的、職人芸的な側面があるので詳細は筆者はこれ以上の記載ができない。


### 6. ppm形式で保存

色きりが終わったらまず、バックアップの意味でファイルをGIMP形式で保存する。
保存する際ファイル名は`label.xcf`とする。
(保存先は、`Ball/01`等色きりしていたディレクトリ)

つぎにレイヤーを表示した状態で`label.ppm`で保存する。
データフォーマットは`Raw`にする。

### 7. 色テーブルファイルの作成

Cygwinのシェルで(色きりフォルダに移動済みとする)

    $ cd _asura
    $ make all

と叩く。
すると`cc/_asura/`に色テーブルファイル`normal.tm2`ができる。


